name: Daily Stock Scan

on:
  schedule:
    # 每天 UTC 時間 21:15 (等於 PST 13:15)
    - cron: '15 21 * * 1-5'
  workflow_dispatch: # 允許手動點擊運行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install yfinance pandas numpy gspread oauth2client

    - name: Create stock_data directory
      run: mkdir -p stock_data

    - name: Run Scanner and Upload to Google Sheets
      env:
    GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
    GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
  run: python stock_scanner_with_sheets.py
      
    - name: List generated files
      run: ls -la stock_data/

    - name: Commit and Push CSV
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A stock_data/
        git commit -m "Auto: Stock scan results $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push
