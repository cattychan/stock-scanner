name: Daily Stock Scan

on:
  schedule:
    # ÊØèÂ§© UTC ÊôÇÈñì 21:15 (Á≠âÊñº PST 13:15)
    - cron: '15 21 * * 1-5'
  workflow_dispatch: # ÂÖÅË®±ÊâãÂãïÈªûÊìäÈÅãË°å

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install yfinance pandas numpy gspread oauth2client

    - name: Create stock_data directory
      run: mkdir -p stock_data

    - name: Run Scanner and Upload to Google Sheets
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      run: python stock_scanner_with_sheets.py
      
    - name: List generated files
      run: ls -la stock_data/

    # üëá Âú®ÈÄôË£°Ê∑ªÂä†Êñ∞Ê≠•È©üÔºÅ
    - name: Create latest_scan.csv for dashboard
      run: |
        cd stock_data
        latest=$(ls -t results_*.csv 2>/dev/null | head -1)
        if [ -n "$latest" ]; then
          cp "$latest" latest_scan.csv
          echo "‚úì Created latest_scan.csv from $latest"
          ls -lh latest_scan.csv
        else
          echo "‚ö†Ô∏è No results files found"
        fi

    - name: Commit and Push CSV
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A stock_data/
        git commit -m "Auto: Stock scan results $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push
